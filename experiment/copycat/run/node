#! /bin/bash

export RUST_LOG=debug
export RUST_BACKTRACE=1

BUILDTYPE=$1
MACHINE_ID=$2
LOCAL_ID=$3
THREADS=$4
CHAIN_TYPE=$5
ACCOUNTS=$6
MAX_INFLIGHT=$7
FREQUENCY=$8
DISSEM=$9
ENABLE_TXN_DISSEM=${10}
CONFIG=${11}

if [[ $CONFIG == "" ]]; then
    CONFIG_ARG=""
else
    CONFIG_ARG="--config ${CONFIG}"
fi

if [[ $ENABLE_TXN_DISSEM == "false" ]]; then
    ENABLE_TXN_DISSEM_ARG=""
else
    ENABLE_TXN_DISSEM_ARG="--disable-txn-dissem"
fi

ID=$(( ($MACHINE_ID << 12) + $LOCAL_ID ))
./blockchain_copycat/target/${BUILDTYPE}/copycat_server -i ${ID} -t ${THREADS} \
    -c ${CHAIN_TYPE} ${CONFIG_ARG} -a ${ACCOUNTS} -f ${MAX_INFLIGHT} -q ${FREQUENCY} \
    --topology bench_topo.json -n ${DISSEM} ${ENABLE_TXN_DISSEM_ARG}
