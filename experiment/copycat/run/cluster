#! /bin/bash

echo "$@"

BUILDTYPE=$1
ID=$2
THREADS=$3
MAILBOX_WORKERS=$4
CHAIN_TYPE=$5
TXN_CRYPTO=$6
P2P_CRYPTO=$7
THRESHOLD_CRYPTO=$8
CONN_MULTIPLY=$9
WARMUP_TIME=${10}
NUM_CLIENTS=${11}
CLIENTS_REMAINDER=${12}
ACCOUNTS=${13}
MAX_INFLIGHT=${14}
FREQUENCY=${15}
CONFLICT_RATE=${16}
TXN_SPAN=${17}
DISABLE_TXN_DISSEM=${18}
SCRIPT_SIZE=${19}

export RUST_LOG=info
export RUST_BACKTRACE=full
export REPORT_PERIOD=30
export WARMUP_TIME=${WARMUP_TIME}

if [[ $DISABLE_TXN_DISSEM == "False" ]]; then
    DISABLE_TXN_DISSEM=""
else
    DISABLE_TXN_DISSEM="--disable-txn-dissem"
fi

if [[ $SCRIPT_SIZE == "" ]]; then 
    SCRIPT_SIZE=""
else
    SCRIPT_SIZE="-z ${SCRIPT_SIZE}"
fi

if (($ID < $CLIENTS_REMAINDER)); then
    CLIENTS=$((NUM_CLIENTS + 1))
else
    CLIENTS=$NUM_CLIENTS
fi

./blockchain_copycat/target/${BUILDTYPE}/copycat_cluster -i ${ID} -t ${THREADS} \
    -w ${MAILBOX_WORKERS} -m bench_machines.json -n bench_network.json -c ${CHAIN_TYPE} \
    --config bench_validators.json -x ${TXN_CRYPTO} -p ${P2P_CRYPTO} -h ${THRESHOLD_CRYPTO} \
    -o ${CONN_MULTIPLY} -l ${CLIENTS} -a ${ACCOUNTS} -f ${MAX_INFLIGHT} -q ${FREQUENCY} \
    -s ${TXN_SPAN} -r ${CONFLICT_RATE} ${DISABLE_TXN_DISSEM} --topology bench_topo.json \
    ${SCRIPT_SIZE}
