#! /bin/bash

BRANCH=$1
BUILDTYPE=$2

GITHUB_ORG=qusuyan
PROJECT_NAME=blockchain_copycat

if [[ ! -e ${PROJECT_NAME} ]]; then
    ssh-keyscan github.com >> ~/.ssh/known_hosts
    git clone git@github.com:${GITHUB_ORG}/${PROJECT_NAME}.git
fi

if [[ $BUILDTYPE == "release" ]]; then
    BUILD_FLAGS="--release"
else
    BUILD_FLAGS=""
fi

cd ${PROJECT_NAME}
# git reset --hard
git pull --ff

echo "Using branch '${BRANCH}'"
git checkout ${BRANCH}

export RUSTFLAGS="--cfg tokio_unstable"

cargo build -p copycat_server ${BUILD_FLAGS}
cargo build -p copycat_mailbox ${BUILD_FLAGS}
cargo build -p copycat_cluster ${BUILD_FLAGS}

exit 0
